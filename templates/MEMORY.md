# MEMORY.md

Cross-session memory for AI agents working on this project. This file captures knowledge
that is too specific for CLAUDE.md but too important to lose between sessions.

Agents: Read this file at session start. Update it at session end when you've learned
something that should persist. Do not add every detail — only things that changed your
approach or would prevent a mistake in a future session.

last_updated: "YYYY-MM-DD (Session NNN)"

---

## Project Facts

<!-- Immutable facts about the project: architecture choices, technology constraints,
     integration details. These don't change without an ADR.
     CUSTOMIZE: Replace with your actual project facts. -->

- Python version: 3.11 (do not suggest upgrading without discussing — pinned for Databricks compatibility)
- Database: DuckDB for local development, [Cloud DB] for production. SQL must be compatible with both.
- All SQL is run through the transform pipeline — no ad hoc queries committed to the codebase
- Test data is generated by factories in `tests/fixtures/` — never use real data in tests
- The `base_connector.py` abstract class must be the parent of every connector — no exceptions

<!-- CUSTOMIZE: Add your own immutable project facts here. -->

---

## Patterns Confirmed

<!-- Patterns that have been validated to work well in this codebase.
     Agents should follow these when building new features.
     CUSTOMIZE: Replace examples with patterns confirmed in your project. -->

- **Connector pattern:** New data sources follow `src/connectors/[source_name].py` with the
  `BaseConnector` interface. See `src/connectors/stripe.py` for the reference implementation.
  This pattern handles: auth, retry, rate limiting, schema validation, bronze write.

- **MERGE INTO for all writes:** All pipeline stages use `MERGE INTO` not `INSERT INTO`.
  This makes all stages safely re-runnable. First introduced in Session 003, confirmed working.

- **Test factories over fixtures:** `tests/fixtures/factories.py` uses the factory pattern
  (not static fixtures). This produces more realistic test data and handles schema changes better.

- **Environment variables for all config:** No hardcoded values in any configuration file.
  Local: `.env` file (gitignored). CI: GitHub Secrets. Production: secrets manager.

<!-- CUSTOMIZE: Add patterns that work well in your codebase. -->

---

## Anti-patterns Discovered

<!-- Patterns that caused problems. Agents must not repeat these.
     CUSTOMIZE: Replace with anti-patterns discovered in your project. -->

- **Do not use `SELECT *` in transforms:** Schema changes in upstream sources broke downstream
  transforms silently. Always list columns explicitly. (Discovered Session 004)

- **Do not modify `base_connector.py` without running all connector tests:** The base class has
  12 subclasses. A change that looked safe in Session 007 broke 3 connectors. Always run
  `pytest tests/integration/` before committing base class changes.

- **Do not assume the bronze layer schema is stable:** Source APIs change their response format
  without warning. Always use `validate_schema()` before writing to bronze.

- **Do not write multi-phase changes in one session:** Session 005 attempted to change both
  the bronze schema and the silver transforms in one session. The result was a broken pipeline
  that took two sessions to debug. One layer per session.

<!-- CUSTOMIZE: Add anti-patterns discovered in your project. -->

---

## Open Decisions

<!-- Things not yet resolved. Agents should not make progress on these unilaterally.
     Flag them when they come up and ask the user to decide.
     CUSTOMIZE: Replace with your actual open decisions. -->

- **Message queue for async processing:** Should the notification system use Redis Pub/Sub
  or AWS SQS? Not decided. Do not implement either without a decision. (Session 006)

- **Caching strategy for expensive API calls:** [Source API] has a 1000 req/day limit and
  some data changes infrequently. Should we cache responses in DuckDB? Not decided. (Session 007)

- **Backfill strategy for new connectors:** When adding a new source, how many months of
  history should the first run fetch? Not standardized. (Session 008)

<!-- CUSTOMIZE: Add your open decisions here. Clear them when resolved (move to DECISIONS.md). -->

---

## Team Preferences

<!-- How this team likes to work with AI agents.
     These aren't rules — they're preferences that make sessions more productive.
     CUSTOMIZE: Replace with your team's actual preferences. -->

- **Session length:** This team works in 1-2 hour sessions. If a task is estimated at more than
  one session, break it down before starting.

- **Verbosity preference:** Show full task reports after each task. Do not abbreviate.
  The team prefers to know exactly what changed even if it feels repetitive.

- **Code review preference:** Always show the diff before committing. Do not auto-commit
  without the user seeing what changed.

- **Uncertainty preference:** When uncertain about an approach, present two options with
  trade-offs rather than picking one silently. Do not guess.

- **Documentation preference:** Update docstrings inline when adding functions.
  Do not save documentation for a separate session.

<!-- CUSTOMIZE: Document how your team prefers to work. -->

---

## Agent Notes

<!-- What this specific agent has learned about working on this project.
     Updated automatically by the agent at session end when relevant.
     CUSTOMIZE: Clear this section when starting your project. -->

- Session 009 revealed that the DuckDB connection pool was not being closed properly after
  tests. Added `connection.close()` to the test teardown. Check for this pattern in new tests.

- The [Source API] returns pagination tokens that expire after 60 seconds. The current
  connector fetches all pages synchronously — this is fine for current data volumes
  (<500 records/day) but will need revisiting if volume increases significantly.

- The user reviews output carefully before approving. Do not rush — show the full diff.

<!-- CUSTOMIZE: Agents add their session-specific learnings here. -->
