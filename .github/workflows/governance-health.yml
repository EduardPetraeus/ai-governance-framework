name: Governance Health Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    # Run every Monday at 09:00 UTC so the team starts the week with a fresh score.
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      threshold:
        description: "Minimum score to pass the health gate (0 = no gate)"
        required: false
        default: "0"

jobs:
  health-score:
    name: Calculate governance health score
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Calculate health score
        id: health-score
        run: |
          # Determine the threshold. Workflow input overrides the default.
          THRESHOLD="${{ github.event.inputs.threshold || '0' }}"

          # Run the health score calculator and capture output.
          python3 automation/health_score_calculator.py . \
            --format json \
            --output-file /tmp/health_report.json

          # Also produce human-readable text for the PR comment.
          python3 automation/health_score_calculator.py . > /tmp/health_report.txt

          # Extract the score and level from the JSON report.
          SCORE=$(python3 -c "import json; d=json.load(open('/tmp/health_report.json')); print(d['score'])")
          LEVEL=$(python3 -c "import json; d=json.load(open('/tmp/health_report.json')); print(d['level'])")
          LABEL=$(python3 -c "import json; d=json.load(open('/tmp/health_report.json')); print(d['level_label'])")

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "label=$LABEL" >> $GITHUB_OUTPUT

          echo "Governance health score: $SCORE/100 — Level $LEVEL ($LABEL)"

          # Apply threshold gate if configured.
          if [ "$THRESHOLD" -gt 0 ] && [ "$SCORE" -lt "$THRESHOLD" ]; then
            echo "gate_failed=true" >> $GITHUB_OUTPUT
          else
            echo "gate_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Post score as PR comment
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          SCORE="${{ steps.health-score.outputs.score }}"
          LEVEL="${{ steps.health-score.outputs.level }}"
          LABEL="${{ steps.health-score.outputs.label }}"
          REPORT=$(cat /tmp/health_report.txt)

          # Choose a status indicator based on maturity level.
          if [ "$LEVEL" -ge 4 ]; then
            STATUS="PASS"
          elif [ "$LEVEL" -ge 2 ]; then
            STATUS="WARN"
          else
            STATUS="INFO"
          fi

          COMMENT_BODY="## Governance Health — $STATUS (Score: $SCORE/100, Level $LEVEL: $LABEL)

          <details>
          <summary>Full health report</summary>

          \`\`\`
          $REPORT
          \`\`\`

          </details>

          See [docs/maturity-model.md](docs/maturity-model.md) for level definitions and upgrade paths.

          ---
          *Generated by [governance-health.yml](.github/workflows/governance-health.yml) using [health_score_calculator.py](automation/health_score_calculator.py)*"

          python3 -c "
          import urllib.request, json

          body = '''$COMMENT_BODY'''
          data = json.dumps({'body': body}).encode('utf-8')
          url = 'https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments'
          req = urllib.request.Request(url, data=data, method='POST')
          req.add_header('Authorization', 'token ${{ github.token }}')
          req.add_header('Content-Type', 'application/json')
          req.add_header('Accept', 'application/vnd.github.v3+json')

          try:
              with urllib.request.urlopen(req) as resp:
                  print(f'Comment posted: {resp.status}')
          except Exception as exc:
              print(f'Failed to post comment: {exc}')
          "

      - name: Upload health report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: governance-health-report
          path: /tmp/health_report.json
          retention-days: 30

      - name: Fail if health gate not met
        if: steps.health-score.outputs.gate_failed == 'true'
        run: |
          SCORE="${{ steps.health-score.outputs.score }}"
          THRESHOLD="${{ github.event.inputs.threshold || '0' }}"
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║                GOVERNANCE HEALTH GATE FAILED                    ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║                                                                  ║"
          echo "║  Score $SCORE is below the required threshold of $THRESHOLD.        ║"
          echo "║                                                                  ║"
          echo "║  Review the health report artifact for specific gaps.            ║"
          echo "║  See docs/maturity-model.md for upgrade paths.                   ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          exit 1
