repos:
  # ─── Secret and credential scanning ────────────────────────────────────────
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.21.2
    hooks:
      - id: gitleaks
        name: Detect secrets and credentials (gitleaks)
        # Scans for patterns like API keys, tokens, passwords using entropy analysis
        # and regex patterns. Faster and more accurate than grep-based checks.
        # Configure allowlists in .gitleaks.toml if needed for false positives.

  # ─── Private key detection (belt-and-suspenders with gitleaks) ───────────
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: detect-private-key
        name: Detect private keys (PEM, RSA, EC, DSA)

      # ─── File integrity checks ─────────────────────────────────────────────
      - id: check-yaml
        name: Validate YAML syntax
        # Validates all .yml and .yaml files. Catches syntax errors before
        # they become CI failures or runtime errors.

      - id: check-json
        name: Validate JSON syntax
        # Validates all .json files including package.json, tsconfig.json, etc.

      - id: check-toml
        name: Validate TOML syntax
        # Validates pyproject.toml, Cargo.toml, and other TOML configs.

      - id: end-of-file-fixer
        name: Ensure files end with a newline
        # POSIX requirement. Prevents "no newline at end of file" git diff noise.

      - id: trailing-whitespace
        name: Remove trailing whitespace
        # Trailing whitespace in Python causes no errors but creates noisy diffs.

      - id: mixed-line-ending
        name: Normalize line endings to LF
        args: [--fix=lf]
        # Prevents CRLF/LF mixed files when working across Windows and macOS/Linux.

      - id: check-merge-conflict
        name: Check for unresolved merge conflicts
        # Catches <<<<<<< HEAD markers left in files after a bad merge.

      - id: check-added-large-files
        name: Prevent large file commits
        args: [--maxkb=500]
        # Blocks files over 500KB. Large files in git are hard to remove.
        # Use git-lfs for binary assets, not the main repository.

  # ─── Python-specific checks ──────────────────────────────────────────────
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.9.1
    hooks:
      - id: ruff
        name: Lint Python with ruff (replaces flake8, isort, pep8)
        args: [--fix]
        # Ruff is 10-100x faster than flake8. Configured via pyproject.toml [tool.ruff].
        # --fix applies safe auto-fixes (import sorting, simple style issues).

      - id: ruff-format
        name: Format Python with ruff formatter (replaces black)
        # Consistent code formatting. No debates about style. Fast.

  # ─── Type checking (optional — remove if not using mypy) ─────────────────
  # - repo: https://github.com/pre-commit/mirrors-mypy
  #   rev: v1.14.1
  #   hooks:
  #     - id: mypy
  #       name: Type check Python with mypy
  #       additional_dependencies: [types-requests, types-PyYAML]
  #       # Uncomment and configure when the project has enough type annotations
  #       # to make mypy useful. Running mypy on a partially typed codebase
  #       # produces more noise than signal.

  # ─── Custom project governance hooks ─────────────────────────────────────
  - repo: local
    hooks:
      - id: check-snake-case-filenames
        name: Validate snake_case filenames in src/
        language: python
        entry: python
        args:
          - -c
          - |
            import sys, os, re

            errors = []
            snake_case_pattern = re.compile(r'^[a-z][a-z0-9_]*\.py$')

            for filepath in sys.argv[1:]:
                # Only check Python files in src/
                if not filepath.startswith('src/'):
                    continue
                if not filepath.endswith('.py'):
                    continue

                filename = os.path.basename(filepath)

                # Allow __init__.py and __main__.py (special Python names)
                if filename.startswith('__') and filename.endswith('__.py'):
                    continue

                if not snake_case_pattern.match(filename):
                    errors.append(
                        f"  {filepath}: '{filename}' is not snake_case. "
                        f"Rename to: {filename.lower().replace('-', '_')}"
                    )

            if errors:
                print("Naming convention violation: src/ files must use snake_case")
                for error in errors:
                    print(error)
                print()
                print("CLAUDE.md requires snake_case for all source files.")
                print("See templates/CLAUDE.md conventions section.")
                sys.exit(1)

        types: [python]
        pass_filenames: true

      - id: check-no-hardcoded-localhost-in-source
        name: Warn on localhost URLs in non-test source files
        language: python
        entry: python
        args:
          - -c
          - |
            import sys, re

            localhost_pattern = re.compile(
                r'(http://localhost|http://127\.0\.0\.1|http://0\.0\.0\.0)',
                re.IGNORECASE
            )

            warnings = []
            for filepath in sys.argv[1:]:
                # Skip test files — localhost is expected in test configs
                if '/tests/' in filepath or 'test_' in filepath or '_test.' in filepath:
                    continue
                # Skip documentation
                if filepath.endswith('.md'):
                    continue

                try:
                    with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                        for i, line in enumerate(f, 1):
                            if localhost_pattern.search(line):
                                # Only warn, not fail — localhost may be intentional in config
                                warnings.append(f"  {filepath}:{i}: {line.strip()}")
                except (IOError, PermissionError):
                    pass

            if warnings:
                print("Warning: localhost URLs found in source files (not tests).")
                print("Ensure these are not hardcoded configuration values:")
                for warning in warnings:
                    print(warning)
                print()
                print("Use environment variables for URLs: os.environ['SERVICE_URL']")
                # Exit 0 — this is a warning, not a hard failure
                # Change to sys.exit(1) to make it blocking

        types_or: [python, yaml, json]
        pass_filenames: true

# ─── Configuration ───────────────────────────────────────────────────────────
default_stages: [pre-commit]
fail_fast: false
# fail_fast: false means all hooks run even if one fails.
# Set to true if you want to stop at the first failure (faster feedback but less complete).
